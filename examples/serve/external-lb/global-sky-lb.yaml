# The template for the sky serve load balancers

name: load-balancer

envs:
  IP:

resources:
  # TODO(tian): Hack. We should figure out the optimal resources.
  cpus: 2+
  ports: 9002

setup: |
  source ~/skypilot-runtime/bin/activate
  # Install serve dependencies.
  # TODO(tian): Gather those into serve constants.
  pip list | grep uvicorn > /dev/null 2>&1 || pip install uvicorn > /dev/null 2>&1
  pip list | grep fastapi > /dev/null 2>&1 || pip install fastapi > /dev/null 2>&1
  pip list | grep httpx > /dev/null 2>&1 || pip install httpx > /dev/null 2>&1
  pip list | grep xxhash > /dev/null 2>&1 || pip install xxhash > /dev/null 2>&1
  pip list | grep prometheus_client > /dev/null 2>&1 || pip install prometheus_client > /dev/null 2>&1

run: |
  source ~/skypilot-runtime/bin/activate
  python -u -m sky.serve.load_balancer \
    --controller-addr http://$IP:20001 \
    --load-balancer-port 9002 \
    --load-balancing-policy prefix_tree \
    --meta-load-balancing-policy prefix_tree \
    --region global