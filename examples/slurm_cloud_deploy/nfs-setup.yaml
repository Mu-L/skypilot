num_nodes: 2

# Using block scalar with chomping indicator (|) for the script
run: |
  set -ex
  
  CONTROLLER_IP=$(echo "$SKYPILOT_NODE_IPS" | head -n1)
  # Get username - works on both AWS (ubuntu) and other clouds
  USERNAME=$(whoami)

  # Define barrier function
  create_barrier() {
    local barrier_name=$1
    local barrier_file="/tmp/${barrier_name}${SKYPILOT_TASK_ID}_barrier"
    
    if [ "$SKYPILOT_NODE_RANK" = "0" ]; then
      # Controller node creates and distributes barrier file
      touch $barrier_file
      for node in $(echo "$SKYPILOT_NODE_IPS" | tail -n +2); do
        scp -o StrictHostKeyChecking=no $barrier_file $node:$barrier_file
      done
    else
      # Non-controller nodes wait for barrier file
      while [ ! -f "$barrier_file" ]; do
        echo "Waiting for $barrier_name barrier..."
        sleep 5
      done
    fi
  }

  # Install NFS on all nodes (server on controller, client on all)
  if [ "$SKYPILOT_NODE_RANK" = "0" ]; then
    # Controller node: Install NFS server
    sudo apt install -y nfs-kernel-server

    # Create /mnt directory if it doesn't exist
    sudo mkdir -p /mnt
    sudo chmod 755 /mnt

    # Add /mnt to exports
    echo "/mnt *(rw,sync,no_subtree_check,no_root_squash)" | sudo tee -a /etc/exports
    sudo exportfs -a
    sudo systemctl restart nfs-kernel-server
    
    # Create a /mnt/home_template directory to copy for new users
    sudo mkdir -p /mnt/home_template
    sudo cp -r /etc/skel/. /mnt/home_template/
    
    echo "NFS server setup complete on controller node"
  else
    # Worker nodes: Install NFS client only
    sudo apt install -y nfs-common
  fi

  # Configure NFS on all nodes
  if [ "$SKYPILOT_NODE_RANK" = "0" ]; then
    # On controller, create a script that will be used to mount NFS on worker nodes
    cat > /tmp/mount_nfs.sh << 'EOF'
  #!/bin/bash
  sudo mkdir -p /mnt
  sudo mount ${CONTROLLER_IP}:/mnt /mnt
  echo "${CONTROLLER_IP}:/mnt /mnt nfs defaults 0 0" | sudo tee -a /etc/fstab
  EOF
    sed -i "s/\${CONTROLLER_IP}/${CONTROLLER_IP}/g" /tmp/mount_nfs.sh
    chmod +x /tmp/mount_nfs.sh
    
    # Distribute to all worker nodes
    for node in $(echo "$SKYPILOT_NODE_IPS" | tail -n +2); do
      scp -o StrictHostKeyChecking=no /tmp/mount_nfs.sh $node:/tmp/
      ssh -o StrictHostKeyChecking=no $node "bash /tmp/mount_nfs.sh"
    done
    
    rm /tmp/mount_nfs.sh
  fi
  
  # Create barrier to ensure NFS is mounted before continuing
  create_barrier "nfs_setup_complete"
  
  echo "NFS setup complete. The /mnt directory is now shared across all nodes."
  echo "You can now create users with home directories under /mnt." 
